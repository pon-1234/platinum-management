# Implementation Plan

- [ ] 1. データベーススキーマの設計と実装
  - 新規テーブル（visit_guests, guest_orders, guest_cast_assignments, guest_billing_splits）を作成する
  - 既存テーブル（visits, order_items）に必要なカラムを追加する
  - 外部キー制約とインデックスを設定する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 2. TypeScript型定義の作成
  - 新しいデータベーステーブルに対応するTypeScript型を定義する
  - VisitGuest, GuestOrder, GuestCastAssignment, BillingSplit等の型を作成する
  - 既存のdatabase.types.tsファイルを更新する
  - _Requirements: 1.1, 2.1, 3.1_

- [ ] 3. 来店ゲスト管理システムの実装
- [ ] 3.1 VisitGuestServiceの実装
  - 来店ゲストのCRUD操作を行うサービスクラスを作成する
  - ゲストの追加、更新、削除、取得機能を実装する
  - ゲスト間の関係性管理機能を実装する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 3.2 複数ゲスト受付UIの実装
  - MultiGuestReceptionFormコンポーネントを作成する
  - 主要顧客選択・同伴者追加フォームを実装する
  - 席順・関係性設定UIを実装する
  - _Requirements: 1.1, 1.2, 1.4_

- [ ] 3.3 既存来店受付システムの拡張
  - 既存の来店受付画面に複数ゲスト機能を統合する
  - 単一顧客モードと複数ゲストモードの切り替えを実装する
  - 後からゲスト追加する機能を実装する
  - _Requirements: 1.1, 1.4_

- [ ] 4. 複数ゲスト注文管理システムの実装
- [ ] 4.1 MultiGuestOrderServiceの実装
  - ゲスト別注文管理を行うサービスクラスを作成する
  - 個別注文・共有注文の処理機能を実装する
  - 注文のゲスト割り当て機能を実装する
  - _Requirements: 2.1, 2.2, 2.4_

- [ ] 4.2 ゲスト選択注文UIの実装
  - GuestOrderManagementコンポーネントを作成する
  - 注文時のゲスト選択UIを実装する
  - 共有アイテムの割合設定UIを実装する
  - _Requirements: 2.1, 2.4_

- [ ] 4.3 既存注文システムの拡張
  - OrderTicketManagementコンポーネントを複数ゲスト対応に拡張する
  - ProductSelectModalにゲスト選択機能を追加する
  - 注文履歴表示をゲスト別に対応させる
  - _Requirements: 2.1, 2.4_

- [ ] 5. キャスト-ゲスト担当関係管理の実装
- [ ] 5.1 ゲスト-キャスト割り当て機能の実装
  - GuestCastAssignmentの作成・更新・削除機能を実装する
  - 指名、同伴、アフター等の担当種別管理を実装する
  - 担当時間の記録・管理機能を実装する
  - _Requirements: 2.2, 2.3_

- [ ] 5.2 キャスト担当状況表示UIの実装
  - 各ゲストの担当キャスト表示機能を実装する
  - キャスト側からの担当ゲスト確認機能を実装する
  - 担当変更・追加のUIを実装する
  - _Requirements: 2.2, 2.3_

- [ ] 5.3 指名システムとの統合
  - 既存の指名システムを複数ゲスト対応に拡張する
  - ゲスト別指名履歴の記録機能を実装する
  - 指名料の正確な計算機能を実装する
  - _Requirements: 2.2, 2.3_

- [ ] 6. 複数ゲスト会計システムの実装
- [ ] 6.1 MultiGuestBillingServiceの実装
  - 個別会計計算機能を実装する
  - 分割会計計算機能を実装する
  - 会計整合性検証機能を実装する
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 6.2 会計方法選択UIの実装
  - 個別会計・合算会計・分割会計の選択UIを実装する
  - ゲスト別消費明細表示機能を実装する
  - 支払い方法の個別設定機能を実装する
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 6.3 部分会計処理の実装
  - 一部ゲストの先行会計処理機能を実装する
  - 残りゲストの継続利用管理機能を実装する
  - 部分会計後の金額調整機能を実装する
  - _Requirements: 3.4, 7.4_

- [ ] 6.4 既存会計システムの拡張
  - 既存の会計処理画面を複数ゲスト対応に拡張する
  - 会計状況のリアルタイム表示機能を実装する
  - 会計完了後の処理を複数ゲスト対応にする
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 7. テーブル管理システムの拡張
- [ ] 7.1 複数ゲストテーブル表示の実装
  - GroupTableManagementコンポーネントを作成する
  - テーブル別ゲスト情報表示機能を実装する
  - 担当キャスト状況の表示機能を実装する
  - _Requirements: 7.1, 7.2_

- [ ] 7.2 グループテーブル操作機能の実装
  - グループ全体のテーブル移動機能を実装する
  - 部分退店処理のUI機能を実装する
  - テーブル状況の更新機能を実装する
  - _Requirements: 7.3, 7.4_

- [ ] 7.3 既存テーブル管理の拡張
  - RealTimeTableDashboardを複数ゲスト対応に拡張する
  - テーブル状況表示を複数ゲスト情報に対応させる
  - テーブル予約システムを複数ゲスト対応にする
  - _Requirements: 7.1, 7.2_

- [ ] 8. 分析・レポート機能の実装
- [ ] 8.1 GuestAnalyticsServiceの実装
  - 顧客別消費パターン分析機能を実装する
  - キャスト-ゲスト関係分析機能を実装する
  - グループ来店パターン分析機能を実装する
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 8.2 複数ゲスト対応レポートUIの実装
  - 顧客分析レポート画面を複数ゲスト対応に拡張する
  - キャスト成績レポートにゲスト別貢献度を追加する
  - グループ来店統計レポートを新規作成する
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 8.3 売上集計システムの拡張
  - 日次・月次売上集計を複数ゲスト対応にする
  - 顧客数と組数の正確な区別機能を実装する
  - キャスト給与計算への正確な売上反映を実装する
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 9. データ整合性とバリデーション機能の実装
- [ ] 9.1 データ整合性チェック機能の実装
  - ゲスト-注文割り当ての整合性チェックを実装する
  - 会計金額の整合性チェックを実装する
  - キャスト担当時間の重複チェックを実装する
  - _Requirements: 5.4, 3.1, 2.4_

- [ ] 9.2 自動修正機能の実装
  - 軽微なデータ不整合の自動修正機能を実装する
  - 会計エラー時の安全な状態復旧機能を実装する
  - データ検証レポート生成機能を実装する
  - _Requirements: 5.4_

- [ ] 9.3 手動修正インターフェースの実装
  - データ不整合の手動修正画面を作成する
  - 修正履歴の記録機能を実装する
  - 修正権限の管理機能を実装する
  - _Requirements: 5.4_

- [ ] 10. データ移行システムの実装
- [ ] 10.1 既存データ移行機能の実装
  - 単一顧客データの主要ゲスト化処理を実装する
  - 移行前後のデータ検証機能を実装する
  - 段階的移行の制御機能を実装する
  - _Requirements: 6.1, 6.2_

- [ ] 10.2 移行監視・ロールバック機能の実装
  - 移行進捗の監視機能を実装する
  - エラー時の詳細ログ記録機能を実装する
  - 安全なロールバック機能を実装する
  - _Requirements: 6.3, 6.4_

- [ ] 10.3 移行検証ツールの実装
  - 移行後のデータ整合性検証ツールを作成する
  - 移行結果のレポート生成機能を実装する
  - 移行完了の確認機能を実装する
  - _Requirements: 6.2_

- [ ] 11. テスト実装
- [ ] 11.1 サービス層のユニットテスト作成
  - VisitGuestServiceのテストを作成する
  - MultiGuestOrderServiceのテストを作成する
  - MultiGuestBillingServiceのテストを作成する
  - 境界値テストとエラーケースのテストを含める

- [ ] 11.2 複数ゲスト機能の統合テスト作成
  - 来店受付から会計完了までのフローテストを作成する
  - 部分退店処理のテストを作成する
  - データ整合性維持のテストを作成する

- [ ] 11.3 既存システム連携テスト作成
  - 顧客管理システムとの連携テストを作成する
  - キャスト管理システムとの連携テストを作成する
  - 会計システムとの連携テストを作成する

- [ ] 12. パフォーマンス最適化の実装
- [ ] 12.1 データベースクエリの最適化
  - 複数ゲスト関連のクエリを最適化する
  - 複合インデックスを追加する
  - 大規模グループ処理のパフォーマンスを向上させる

- [ ] 12.2 UI パフォーマンスの最適化
  - 大規模グループ表示の仮想化を実装する
  - リアルタイム更新の効率化を実装する
  - レスポンシブデザインを最適化する

- [ ] 13. セキュリティとアクセス制御の実装
- [ ] 13.1 アクセス制御の実装
  - ゲスト情報へのアクセス制限を実装する
  - 会計情報の閲覧権限管理を実装する
  - 個人情報保護機能を実装する

- [ ] 13.2 データ保護機能の実装
  - ゲスト関係情報の暗号化を実装する
  - 会計データの改ざん防止機能を実装する
  - 監査ログの記録機能を実装する

- [ ] 14. システム統合とデプロイ準備
- [ ] 14.1 既存システムとの統合テスト
  - 全体システムの統合テストを実行する
  - パフォーマンステストを実行する
  - セキュリティテストを実行する

- [ ] 14.2 本番環境への移行準備
  - データベースマイグレーションスクリプトを作成する
  - 本番データの移行計画を策定する
  - ユーザートレーニング資料を作成する
