# Implementation Plan

- [ ] 1. データベーススキーマの設計と実装
  - 新規テーブル（payroll_rules, nomination_types, sales_tiers, item_back_rates, cast_payroll_assignments, payroll_calculations, payroll_details）を作成する
  - 既存のorder_itemsテーブルに指名種別関連カラムを追加する
  - 必要なインデックスとトリガーを設定する
  - _Requirements: 1.2, 2.1, 3.1, 4.1_

- [ ] 2. TypeScript型定義の作成
  - 新しいデータベーステーブルに対応するTypeScript型を定義する
  - PayrollRule, NominationType, SalesTier, PayrollCalculation等の型を作成する
  - 既存のdatabase.types.tsファイルを更新する
  - _Requirements: 1.2, 2.1, 3.1, 4.1_

- [ ] 3. 指名種別管理システムの実装
- [ ] 3.1 NominationServiceの実装
  - 指名種別のCRUD操作を行うサービスクラスを作成する
  - 指名種別の作成、更新、取得、削除機能を実装する
  - バリデーション機能を含める
  - _Requirements: 2.1, 2.2_

- [ ] 3.2 指名種別管理UIコンポーネントの作成
  - 指名種別一覧表示コンポーネントを作成する
  - 指名種別作成・編集フォームコンポーネントを作成する
  - 指名種別削除確認モーダルを実装する
  - _Requirements: 2.1, 2.2_

- [ ] 3.3 注文システムへの指名種別統合
  - OrderTicketManagementコンポーネントに指名種別選択機能を追加する
  - ProductSelectModalに指名種別選択UIを統合する
  - 注文作成時に指名種別を記録する機能を実装する
  - _Requirements: 2.3, 2.4_

- [ ] 4. 給与計算ルール管理システムの実装
- [ ] 4.1 PayrollRuleServiceの実装
  - 給与計算ルールのCRUD操作を行うサービスクラスを作成する
  - ルールの整合性検証機能を実装する
  - キャストへのルール割り当て機能を実装する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 4.2 売上スライド管理機能の実装
  - SalesTierの作成・編集・削除機能を実装する
  - 売上段階の重複・欠落検証を実装する
  - 段階的バック率計算ロジックを実装する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 4.3 項目別バック率管理機能の実装
  - ItemBackRateの作成・編集・削除機能を実装する
  - 商品カテゴリ別のバック率設定機能を実装する
  - 最低保証額・上限額の設定機能を実装する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 4.4 給与ルール管理UIの作成
  - PayrollRuleManagementコンポーネントを作成する
  - ルール一覧表示、作成・編集フォームを実装する
  - 売上スライドと項目別バック率の設定UIを実装する
  - _Requirements: 1.1, 1.2, 1.4_

- [ ] 5. 給与計算エンジンの実装
- [ ] 5.1 PayrollCalculationServiceの基本実装
  - 基本給計算機能（時給×勤務時間）を実装する
  - 勤怠データとの連携機能を実装する
  - 計算結果の保存・取得機能を実装する
  - _Requirements: 5.1, 6.2_

- [ ] 5.2 売上スライド計算ロジックの実装
  - キャストの月間売上集計機能を実装する
  - 売上段階に応じたバック率適用ロジックを実装する
  - 複数段階にまたがる場合の段階的計算を実装する
  - _Requirements: 3.2, 3.3_

- [ ] 5.3 指名種別別バック計算の実装
  - 注文データから指名種別を取得する機能を実装する
  - 指名種別ごとのバック率適用ロジックを実装する
  - 指名料の計算機能を実装する
  - _Requirements: 2.3, 2.4_

- [ ] 5.4 項目別バック計算の実装
  - 商品カテゴリ別の売上集計機能を実装する
  - カテゴリ別バック率適用ロジックを実装する
  - 最低保証額・上限額の適用機能を実装する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 5.5 一括給与計算機能の実装
  - 複数キャストの同時計算機能を実装する
  - 計算進捗表示機能を実装する
  - エラーハンドリングと部分的失敗への対応を実装する
  - _Requirements: 5.1, 5.2_

- [ ] 6. 給与計算結果の管理と表示
- [ ] 6.1 月次給与計算画面の実装
  - MonthlyPayrollCalculationコンポーネントを作成する
  - 計算対象期間・キャスト選択UIを実装する
  - 計算実行・結果プレビュー機能を実装する
  - _Requirements: 5.1, 5.2_

- [ ] 6.2 給与明細表示機能の実装
  - PayrollDetailViewコンポーネントを作成する
  - 給与明細の詳細表示機能を実装する
  - 計算根拠の表示機能を実装する
  - _Requirements: 6.1, 6.2_

- [ ] 6.3 給与計算の承認機能の実装
  - 計算結果の承認ワークフローを実装する
  - 異常値検出・警告表示機能を実装する
  - 承認履歴の記録機能を実装する
  - _Requirements: 5.3, 6.2_

- [ ] 7. キャスト向け成績表示機能の実装
- [ ] 7.1 CastPerformanceDashboardの拡張
  - 既存のキャスト成績画面を給与見込み表示に対応させる
  - 当月売上・給与見込みの表示機能を実装する
  - リアルタイム更新機能を実装する
  - _Requirements: 7.1_

- [ ] 7.2 目標達成状況表示の実装
  - 売上目標と現在の進捗を表示する機能を実装する
  - 次の売上段階までの必要売上を計算・表示する機能を実装する
  - 日別・週別の成績推移グラフを実装する
  - _Requirements: 7.2, 7.3_

- [ ] 7.3 プライバシー制御の実装
  - キャスト個人の閲覧権限制御を実装する
  - 管理者・経理担当者の全データアクセス権限を実装する
  - データ表示範囲の制限機能を実装する
  - _Requirements: 7.4_

- [ ] 8. レポート機能の実装
- [ ] 8.1 PayrollReportServiceの実装
  - 給与サマリーレポート生成機能を実装する
  - キャスト別給与詳細レポート生成機能を実装する
  - 期間比較レポート生成機能を実装する
  - _Requirements: 6.3_

- [ ] 8.2 データエクスポート機能の実装
  - 給与データのCSV/Excel出力機能を実装する
  - PDF形式での給与明細出力機能を実装する
  - フィルタリング・ソート機能を実装する
  - _Requirements: 6.1, 6.3_

- [ ] 9. バリデーションとエラーハンドリングの実装
- [ ] 9.1 データ整合性チェックの実装
  - 売上データの存在確認機能を実装する
  - 勤怠データの整合性確認機能を実装する
  - 計算ルールの矛盾検出機能を実装する
  - _Requirements: 1.4, 5.4_

- [ ] 9.2 異常値検出機能の実装
  - 前月比大幅変動の検出機能を実装する
  - 異常に高い/低い給与額の検出機能を実装する
  - 警告表示とアラート機能を実装する
  - _Requirements: 5.2_

- [ ] 9.3 エラー回復機能の実装
  - 計算エラー時の自動再試行機能を実装する
  - 部分的失敗時の継続処理機能を実装する
  - 手動修正・再計算機能を実装する
  - _Requirements: 5.4, 6.4_

- [ ] 10. テストの実装
- [ ] 10.1 サービス層のユニットテスト作成
  - PayrollCalculationServiceのテストを作成する
  - PayrollRuleServiceのテストを作成する
  - NominationServiceのテストを作成する
  - 境界値テストとエラーケースのテストを含める

- [ ] 10.2 給与計算ロジックの統合テスト作成
  - 売上データ取得から給与計算完了までのフローテストを作成する
  - 複数キャストの一括計算テストを作成する
  - データ整合性テストを作成する

- [ ] 10.3 UIコンポーネントのテスト作成
  - 給与計算ルール管理画面のテストを作成する
  - 月次給与計算画面のテストを作成する
  - 給与明細表示画面のテストを作成する

- [ ] 11. パフォーマンス最適化の実装
- [ ] 11.1 データベースクエリの最適化
  - 給与計算用のインデックスを追加する
  - 大量データ処理用のクエリを最適化する
  - 計算結果のキャッシュ機能を実装する

- [ ] 11.2 UI パフォーマンスの最適化
  - 大量データ表示の仮想化を実装する
  - 計算進捗の表示機能を実装する
  - 非同期処理によるUX向上を実装する

- [ ] 12. セキュリティとアクセス制御の実装
- [ ] 12.1 権限管理の実装
  - 給与データへのアクセス制限を実装する
  - ロールベースのアクセス制御を実装する
  - 計算ルール変更の権限管理を実装する

- [ ] 12.2 監査ログの実装
  - 給与計算実行ログの記録機能を実装する
  - ルール変更履歴の記録機能を実装する
  - 承認・修正の追跡機能を実装する

- [ ] 13. システム統合とデプロイ準備
- [ ] 13.1 既存システムとの統合テスト
  - キャスト管理システムとの連携テストを実行する
  - 勤怠管理システムとの連携テストを実行する
  - 売上管理システムとの連携テストを実行する

- [ ] 13.2 本番環境への移行準備
  - データベースマイグレーションスクリプトを作成する
  - 既存データの移行・変換処理を実装する
  - 本番環境でのパフォーマンステストを実行する