# Implementation Plan

- [ ] 1. データベーススキーマの拡張
  - 新規テーブル（bottle_keep_locations, bottle_keep_notifications, bottle_keep_movement_logs）を作成する
  - 既存テーブル（bottle_keeps, bottle_keep_usage）に必要なカラムを追加する
  - インデックスと外部キー制約を設定する
  - _Requirements: 1.1, 7.1, 7.2_

- [ ] 2. TypeScript型定義の更新
  - 新しいデータベーステーブルに対応するTypeScript型を定義する
  - CustomerBottleKeep, BottleKeepLocation, BottleKeepNotification等の型を作成する
  - 既存のdatabase.types.tsファイルを更新する
  - _Requirements: 1.1, 2.1, 3.1_

- [ ] 3. ボトルキープ統合サービスの実装
- [ ] 3.1 BottleKeepIntegrationServiceの実装
  - 顧客別ボトルキープ取得機能を実装する
  - 顧客詳細からのボトルキープ追加機能を実装する
  - ボトルキープ検索・フィルタリング機能を実装する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 3.2 既存BottleKeepServiceの拡張
  - 既存のボトルキープサービスに統合機能を追加する
  - 顧客関連データの取得機能を強化する
  - 保管場所管理機能を追加する
  - _Requirements: 1.1, 7.1, 7.2_

- [ ] 4. 顧客詳細画面へのボトルキープ統合
- [ ] 4.1 CustomerBottleKeepPanelコンポーネントの作成
  - 顧客のボトルキープ一覧表示コンポーネントを作成する
  - 残量・期限の視覚的表示機能を実装する
  - 新規ボトルキープ追加ボタンを実装する
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 4.2 既存顧客詳細画面の拡張
  - CustomerDetailClientコンポーネントにボトルキープパネルを統合する
  - ボトルキープ情報の取得・表示機能を実装する
  - 期限切れ警告の表示機能を実装する
  - _Requirements: 1.1, 1.4_

- [ ] 4.3 ボトルキープ使用履歴表示の実装
  - 使用履歴表示コンポーネントを作成する
  - 日付別・キャスト別の使用履歴を表示する機能を実装する
  - 使用パターンの分析表示機能を実装する
  - _Requirements: 4.2_

- [ ] 5. 接客支援機能の実装
- [ ] 5.1 BottleKeepQuickAccessコンポーネントの作成
  - 来店中顧客のボトルキープ表示コンポーネントを作成する
  - ワンクリック使用記録機能を実装する
  - 保管場所の表示機能を実装する
  - _Requirements: 2.1, 2.2, 7.3_

- [ ] 5.2 ボトルキープ使用記録機能の実装
  - BottleKeepUsageServiceを拡張する
  - 簡単な使用量記録機能を実装する
  - 残量自動計算・更新機能を実装する
  - _Requirements: 2.2, 2.3_

- [ ] 5.3 優先順位表示機能の実装
  - 複数ボトルキープの優先順位表示機能を実装する
  - おすすめボトルの提案機能を実装する
  - 使用頻度に基づく並び替え機能を実装する
  - _Requirements: 2.4_

- [ ] 6. 保管場所管理システムの実装
- [ ] 6.1 BottleKeepLocationManagerコンポーネントの作成
  - 保管場所一覧・編集コンポーネントを作成する
  - 場所別ボトル表示機能を実装する
  - 容量管理機能を実装する
  - _Requirements: 7.1, 7.2_

- [ ] 6.2 ボトル移動管理機能の実装
  - ボトル移動記録機能を実装する
  - 移動履歴の表示機能を実装する
  - 保管場所検索機能を実装する
  - _Requirements: 7.2, 7.3_

- [ ] 6.3 保管場所最適化機能の実装
  - 満杯時の代替場所提案機能を実装する
  - 保管効率の分析機能を実装する
  - 自動配置提案機能を実装する
  - _Requirements: 7.4_

- [ ] 7. 分析・レポート機能の実装
- [ ] 7.1 BottleKeepAnalyticsServiceの実装
  - 顧客別ボトルキープレポート生成機能を実装する
  - 期限切れ警告レポート生成機能を実装する
  - 売上貢献度分析機能を実装する
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 7.2 BottleKeepAnalyticsDashboardの作成
  - 期限切れ予定一覧表示機能を実装する
  - 売上貢献度分析表示機能を実装する
  - 在庫推奨レポート表示機能を実装する
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 7.3 在庫連携機能の実装
  - ボトルキープ需要を考慮した発注提案機能を実装する
  - 在庫不足アラート機能を実装する
  - 商品別ボトルキープ統計機能を実装する
  - _Requirements: 3.4_

- [ ] 8. 通知システムの実装
- [ ] 8.1 BottleKeepNotificationServiceの実装
  - 期限切れ通知スケジューリング機能を実装する
  - 残量少量通知機能を実装する
  - 消費完了通知機能を実装する
  - _Requirements: 4.3, 1.4_

- [ ] 8.2 顧客向け通知機能の実装
  - 顧客への期限切れ事前通知機能を実装する
  - ボトルキープサマリー送信機能を実装する
  - おすすめ商品提案通知機能を実装する
  - _Requirements: 4.1, 4.3, 4.4_

- [ ] 8.3 スタッフ向けアラート機能の実装
  - 期限切れ間近アラート機能を実装する
  - 在庫不足アラート機能を実装する
  - 異常データ検出アラート機能を実装する
  - _Requirements: 6.2_

- [ ] 9. 会計処理統合の実装
- [ ] 9.1 ボトルキープ会計処理の実装
  - 前受金計上機能を実装する
  - 消費時の売上振り替え機能を実装する
  - 期限切れ時の会計処理機能を実装する
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 9.2 返金処理機能の実装
  - ボトルキープ返金処理機能を実装する
  - 返金仕訳記録機能を実装する
  - 返金履歴管理機能を実装する
  - _Requirements: 5.4_

- [ ] 9.3 会計レポート統合の実装
  - ボトルキープ売上レポートを既存会計システムに統合する
  - 前受金残高レポート機能を実装する
  - 税務処理用データ出力機能を実装する
  - _Requirements: 5.1, 5.2_

- [ ] 10. データ整合性管理の実装
- [ ] 10.1 整合性チェック機能の実装
  - ボトル在庫と記録の一致確認機能を実装する
  - 使用量と残量の計算整合性チェック機能を実装する
  - 保管場所容量制限チェック機能を実装する
  - _Requirements: 6.1_

- [ ] 10.2 異常データ検出・修正機能の実装
  - 異常データ自動検出機能を実装する
  - 詳細エラーレポート生成機能を実装する
  - 安全なデータ修正機能を実装する
  - _Requirements: 6.2, 6.3_

- [ ] 10.3 データ復旧機能の実装
  - システム障害時のデータ復旧機能を実装する
  - バックアップ・リストア機能を実装する
  - 復旧ログ記録機能を実装する
  - _Requirements: 6.4_

- [ ] 11. 既存システムとの統合
- [ ] 11.1 顧客管理システム統合の完成
  - 顧客データとの完全同期機能を実装する
  - 顧客分析へのボトルキープデータ反映を実装する
  - 顧客セグメンテーションへの統合を実装する

- [ ] 11.2 在庫管理システム統合の実装
  - 商品マスタとの連携強化を実装する
  - 在庫数量との整合性確保機能を実装する
  - 発注システムとの連携を実装する

- [ ] 11.3 売上管理システム統合の実装
  - 売上データへのボトルキープ情報統合を実装する
  - 売上分析レポートへの反映を実装する
  - キャスト成績へのボトルキープ貢献度反映を実装する

- [ ] 12. テスト実装
- [ ] 12.1 サービス層のユニットテスト作成
  - BottleKeepIntegrationServiceのテストを作成する
  - BottleKeepUsageServiceのテストを作成する
  - BottleKeepAnalyticsServiceのテストを作成する
  - 境界値テストとエラーケースのテストを含める

- [ ] 12.2 統合機能のテスト作成
  - 顧客詳細画面統合のテストを作成する
  - 会計処理統合のテストを作成する
  - 通知システム統合のテストを作成する

- [ ] 12.3 データ整合性テストの作成
  - 在庫整合性チェックのテストを作成する
  - 会計整合性チェックのテストを作成する
  - データ修正機能のテストを作成する

- [ ] 13. パフォーマンス最適化の実装
- [ ] 13.1 データベースクエリの最適化
  - ボトルキープ検索用インデックスを追加する
  - 顧客別データ取得クエリを最適化する
  - 分析レポート生成クエリを最適化する

- [ ] 13.2 UI パフォーマンスの最適化
  - 大量ボトルキープ表示の仮想化を実装する
  - 画像表示の遅延読み込みを実装する
  - リアルタイム更新の効率化を実装する

- [ ] 14. セキュリティとアクセス制御の実装
- [ ] 14.1 アクセス制御の実装
  - ボトルキープ情報へのアクセス制限を実装する
  - 顧客プライバシー保護機能を実装する
  - 在庫情報の機密性確保機能を実装する

- [ ] 14.2 データ保護機能の実装
  - ボトルキープ情報の暗号化を実装する
  - 使用履歴の改ざん防止機能を実装する
  - 監査ログの記録機能を実装する

- [ ] 15. システム統合とデプロイ準備
- [ ] 15.1 全体システムとの統合テスト
  - 既存システムとの連携テストを実行する
  - パフォーマンステストを実行する
  - セキュリティテストを実行する

- [ ] 15.2 本番環境への移行準備
  - データベースマイグレーションスクリプトを作成する
  - 既存ボトルキープデータの移行処理を実装する
  - ユーザートレーニング資料を作成する
