# セキュリティベストプラクティス

このドキュメントでは、Platinum Management Systemのセキュリティを維持するためのベストプラクティスを記載します。

## 1. 認証情報の管理

### ❌ してはいけないこと
- 認証情報（パスワード、APIキー、シークレットキー）をソースコードに直接記述しない
- 設定ファイル（.json、.jsなど）に認証情報を含めない
- Git履歴に認証情報を残さない

### ✅ 推奨される方法
- すべての認証情報は環境変数（`.env.local`）で管理する
- `.env.local`は必ず`.gitignore`に含める
- 本番環境ではVercelの環境変数設定を使用する

## 2. データベースの権限管理

### 原則
- **最小権限の原則**: 各ロールには必要最小限の権限のみを付与する
- **anonロールには権限を付与しない**: 匿名ユーザーがアクセスできる機能は原則として存在しない

### 実装
```sql
-- ❌ 悪い例：anonロールに全関数の実行権限を付与
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO anon;

-- ✅ 良い例：必要な関数のみに個別に権限を付与
GRANT EXECUTE ON FUNCTION specific_public_function TO authenticated;
```

## 3. Row Level Security (RLS)

### 必須事項
- すべてのテーブルでRLSを有効にする
- 適切なポリシーを設定して、ユーザーが自分のデータのみにアクセスできるようにする
- `SECURITY DEFINER`関数を使用する場合は、無限再帰を避けるための対策を実装する

## 4. API設計

### 原則
- Server Actionsを使用して、サーバーサイドで認証とバリデーションを実施
- Zodスキーマによる厳格な入力値検証
- エラーメッセージに機密情報を含めない

## 5. Git管理

### 定期的な確認
```bash
# 機密情報が含まれていないか確認
git log --all -p -S "password\|secret\|key" | grep -i "password\|secret\|key"
```

### 機密情報が見つかった場合
1. 該当するキーやパスワードを即座に無効化・再発行
2. Git履歴から完全に削除（BFG Repo-Cleanerなどを使用）

## 6. 依存関係の管理

### 推奨事項
- 定期的に`npm audit`または`pnpm audit`を実行
- 脆弱性が見つかった場合は速やかに更新
- 自動化されたセキュリティスキャンの導入を検討

## 7. 開発プロセス

### コードレビュー
- すべてのPRでセキュリティの観点からレビューを実施
- 特に認証・認可に関わる変更は慎重に確認

### CI/CDパイプライン
- GitHub ActionsでGitleaksなどのシークレットスキャナーを導入
- 自動的にセキュリティチェックを実行

## 8. 監査ログ

### 推奨事項
- 重要な操作（ユーザー作成、権限変更など）のログを記録
- 定期的にログを確認し、不審なアクティビティがないか確認

## 9. 定期的なセキュリティレビュー

### チェックリスト
- [ ] 環境変数の確認（不要なものは削除）
- [ ] データベース権限の確認
- [ ] RLSポリシーの確認
- [ ] 依存関係の脆弱性チェック
- [ ] Git履歴の確認
- [ ] アクセスログの確認

## まとめ

セキュリティは継続的なプロセスです。これらのベストプラクティスを守り、定期的にレビューを行うことで、システムのセキュリティを維持できます。