
# システム設計書: platinum-management

| | |
| :--- | :--- |
| **ドキュメントバージョン** | 2.0 |
| **作成日** | 2023年10月27日 |
| **作成者** | (担当者名) |
| **最終更新日** | 2025年1月27日 |

> **Note**: 本ドキュメントは、プロジェクトの設計情報を集約した単一の情報源です。

---

## **目次**
1. システム概要
2. システムアーキテクチャ
3. ユーザーロールと権限
4. 機能仕様詳細（フェーズ1: 必須機能）
    - 4.1. 顧客管理 (CRM)
    - 4.2. キャスト管理
    - 4.3. 予約・席管理
    - 4.4. 勤怠・シフト管理
    - 4.5. 売上・会計
    - 4.6. 在庫・ボトルキープ
    - 4.7. 年齢確認・法令対応
5. データベース設計（主要テーブルの抜粋）
6. 開発ロードマップ
7. 開発方針・品質保証
    - 7.1. 開発目標
    - 7.2. 開発手法
    - 7.3. 品質基準 (制約事項)
    - 7.4. 開発プロセスの自動化 (CI/CD)
    - 7.5. 開発ドキュメント
8. 別紙: 開発ガイドライン（参考例）

---

### 1. システム概要

| 項目 | 内容 |
| :--- | :--- |
| **システム名** | platinum-management （プラチナム・マネジメント） |
| **目的** | ラウンジ（接待飲食等営業）の運営における、顧客・キャスト・売上・予約・在庫等の情報を一元管理し、業務効率化、法令遵守、および売上向上を実現する。 |
| **ターゲットユーザー** | 店舗経営者、マネージャー、ホールスタッフ、会計担当、キャスト |
| **システムの特徴** | ・**モダンな技術スタック:** VercelとSupabaseを採用し、高速なレスポンスと高い開発効率、スケーラビリティを実現。<br>・**リアルタイム連携:** 予約状況や席状況がリアルタイムで全端末に同期され、スムーズな店舗運営をサポート。<br>・**段階的導入:** まずは業務に必須のコア機能から導入し、店舗の成長に合わせて拡張機能を追加できる柔軟な設計。 |

---

### 2. システムアーキテクチャ

VercelとSupabaseを中心に、モダンでスケーラブルな構成を想定します。

| コンポーネント | 技術選定 | 役割・選定理由 |
| :--- | :--- | :--- |
| **フロントエンド** | **Next.js (React)** | ・Vercelとの親和性が非常に高く、デプロイやプレビューが容易。<br>・UI/UXの構築に優れ、PC・タブレット・スマートフォンに対応したレスポンシブデザインを効率的に開発できる。 |
| **ホスティング** | **Vercel** | ・Next.jsの機能を最大限に活かせるホスティング環境。<br>・Git連携による自動デプロイ（CI/CD）が標準で備わっており、迅速な機能改善が可能。 |
| **データベース** | **Supabase (PostgreSQL)** | ・信頼性の高いPostgreSQLをベースにしたBaaS (Backend as a Service)。<br>・データベースだけでなく、認証・ストレージ・リアルタイム機能などを一括で提供し、開発を加速させる。 |
| **認証** | **Supabase Auth** | ・メールアドレス/パスワード認証を基本とし、スタッフやキャストのアカウントを管理。<br>・**RLS (Row Level Security)** と連携し、「キャストは自分の成績しか見れない」といった強力なアクセス制御をDBレベルで実現。 |
| **ファイルストレージ** | **Supabase Storage** | ・身分証明書の画像、キャストのプロフィール写真などを安全に保管。<br>・認証情報と連携し、許可されたユーザーのみがファイルにアクセスできるよう制御可能。 |
| **リアルタイム機能** | **Supabase Realtime** | ・予約や席のステータス変更を、WebSocketを通じて全端末にリアルタイムで配信。<br>・ホールスタッフと受付間の情報連携ラグをなくす。 |

---

### 3. ユーザーロールと権限

役割に応じたアクセス制御を行い、セキュリティと情報管理を徹底します。

| ロール | 主な利用機能 | 権限の概要 |
| :--- | :--- | :--- |
| **管理者 (Admin)** | 全機能 | 全データへのアクセス・編集。システム設定、スタッフアカウント管理、全店舗の売上分析など、最高権限を持つ。 |
| **マネージャー (Manager)** | 顧客/キャスト/予約/売上/勤怠/在庫管理 | 店舗運営に必要なほぼ全ての機能にアクセス。キャストの報酬計算、日報作成、トラブル対応記録などを行う。 |
| **ホールスタッフ (Hall Staff)** | 予約・席管理、フロアオーダー | 顧客の来店受付、席への案内、オーダー入力が主な業務。個人情報や売上詳細へのアクセスは制限。 |
| **会計 (Cashier)** | 売上・会計 | 特定の伝票に対する会計処理、レジ締め業務に特化。過去の売上データへのアクセスは可能だが、編集は制限。 |
| **キャスト (Cast)** | キャスト管理（自身）、シフト管理（自身） | 自身のプロフィール確認・編集、シフト希望の提出、個人の売上成績の確認のみ可能。他キャストや顧客の情報にはアクセス不可。 |

---

### 4. 機能仕様詳細（フェーズ1: 必須機能）

まずは「無ければ業務が回らない」機能から実装します。

#### 4.1. 顧客管理 (CRM)
| 機能 | 詳細仕様 |
| :--- | :--- |
| **顧客情報登録・検索** | ・氏名、フリガナ、電話番号、LINE ID、誕生日、メモ（特徴、会話内容など）を登録。<br>・あらゆる項目でインクリメンタル検索が可能。 |
| **来店履歴** | ・過去の来店日、利用金額、同伴キャスト、注文内容（特にボトル）を時系列で表示。 |
| **ステータス管理** | ・「VIP」「要注意」「ブラックリスト」などのフラグを設定。フラグに応じて予約時や来店時にアラートを表示。 |
| **名刺・情報管理** | ・顧客から頂いた名刺の画像をアップロードし、顧客情報に紐づけて保管。 |

#### 4.2. キャスト管理
| 機能 | 詳細仕様 |
| :--- | :--- |
| **プロフィール管理** | ・キャスト自身が源氏名、写真、自己紹介文を更新可能（マネージャーの承認制も可）。<br>・運営側で時給、各種バック率（指名、ボトル等）を設定。 |
| **成績管理** | ・日/週/月単位で指名本数、売上、同伴数などを自動集計。<br>・店舗内ランキングを自動生成し、キャストのモチベーション向上に繋げる。 |
| **報酬計算補助** | ・設定された時給とバック率、勤怠記録、成績に基づき、給与計算用のデータ（CSV/Excel形式）を出力。 |

#### 4.3. 予約・席管理
| 機能 | 詳細仕様 |
| :--- | :--- |
| **席レイアウト表示** | ・店舗の座席レイアウトをGUIで可視化。<br>・席のステータス（空席、予約、案内中、清掃中）を色分けで直感的に表示。 |
| **リアルタイム更新** | ・Supabase Realtimeを利用し、ある端末で席の状況を変更すると、即座に全端末の画面に反映される。 |
| **予約登録** | ・日付、時間、人数、顧客情報、指名キャスト、要望（VIP席希望など）を登録。<br>・登録された予約は、カレンダー形式とリスト形式で一覧表示。 |

#### 4.4. 勤怠・シフト管理
| 機能 | 詳細仕様 |
| :--- | :--- |
| **シフト管理** | ・キャストが専用画面からシフト希望日を提出。<br>・マネージャーが希望を基にシフトを確定。確定シフトはカレンダーで一覧可能。 |
| **勤怠打刻** | ・出退勤時に従業員番号やQRコードで打刻。時刻を自動記録。<br>・遅刻、早退、休憩時間も記録し、実働時間を自動計算。 |
| **勤怠レポート** | ・月次の勤怠データを一覧で確認し、CSV形式で出力可能。 |

#### 4.5. 売上・会計
| 機能 | 詳細仕様 |
| :--- | :--- |
| **伝票（オーダー）管理** | ・テーブルごとに伝票を作成。<br>・セット料金、指名料（本指名/場内）、延長料金、ドリンク・フードを登録。 |
| **自動料金計算** | ・オーダー内容に基づき、小計、サービス料（例: 15%）、消費税を自動計算し、合計金額を算出。<br>・割引やクーポン適用にも対応。 |
| **会計処理** | ・会計時に「現金」「クレジットカード」等の支払い方法を記録。<br>・会計完了後、伝票はロックされ編集不可となる（マネージャー権限で解除可）。<br>・インボイス制度に対応した領収書の発行機能。 |
| **レジ締め・日報** | ・営業終了後、当日の全伝票を集計し、現金・カード別の売上レポートを自動生成。 |

#### 4.6. 在庫・ボトルキープ
| 機能 | 詳細仕様 |
| :--- | :--- |
| **商品マスタ管理** | ・酒類、フード、タバコ等の商品名、価格、原価を登録。 |
| **在庫管理** | ・オーダーが入ると、紐づく商品の在庫数が自動で減少。<br>・設定した閾値を下回った場合にアラートを通知する機能。 |
| **ボトルキープ管理** | ・顧客情報に紐づけて、キープしたボトルの銘柄、開封日、保管期限を登録。<br>・来店時にその顧客のボトルキープ情報を即座に確認できる。 |

#### 4.7. 年齢確認・法令対応
| 機能 | 詳細仕様 |
| :--- | :--- |
| **身分証保管** | ・初回顧客の身分証明書をスキャンまたは撮影し、画像をSupabase Storageにアップロード。<br>・画像は顧客情報に紐づけ、暗号化して安全に保管。アクセスはマネージャー以上に限定。 |
| **帳票出力** | ・風営法で定められた「従業者名簿」「苦情処理簿」などのフォーマットでデータを出力する機能。 |

---

### 5. データベース設計（主要テーブルの抜粋）

Supabase (PostgreSQL) で構築するテーブルの主要なものを以下に示します。RLS (Row Level Security) を各テーブルに設定し、ロールベースのアクセス制御を徹底します。

```sql
-- スタッフ（キャスト、ホール含む）
CREATE TABLE staffs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID UNIQUE REFERENCES auth.users(id), -- Supabase AuthのユーザーID
  full_name TEXT NOT NULL,
  role TEXT NOT NULL, -- 'admin', 'manager', 'hall', 'cast'
  hire_date DATE,
  is_active BOOLEAN DEFAULT true
);

-- キャスト情報（スタッフテーブルと1対1）
CREATE TABLE casts_profile (
  staff_id UUID PRIMARY KEY REFERENCES staffs(id),
  nickname TEXT NOT NULL,
  profile_image_url TEXT,
  bio TEXT,
  hourly_wage INT,
  commission_rate JSONB -- { "shimei": 1000, "bottle_percent": 0.1 }
);

-- 顧客
CREATE TABLE customers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  phone_number TEXT UNIQUE,
  line_id TEXT,
  birthday DATE,
  memo TEXT,
  status TEXT DEFAULT 'normal' -- 'vip', 'caution', 'blacklisted'
);

-- 来店情報
CREATE TABLE visits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id UUID REFERENCES customers(id),
  table_id INT,
  check_in_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  check_out_at TIMESTAMPTZ,
  num_of_guests INT NOT NULL,
  total_amount INT
);

-- 注文明細
CREATE TABLE order_items (
  id BIGSERIAL PRIMARY KEY,
  visit_id UUID REFERENCES visits(id),
  product_id INT, -- 商品マスタへのFK
  cast_id UUID REFERENCES staffs(id), -- ドリンクバックや指名料の対象キャスト
  quantity INT NOT NULL,
  unit_price INT NOT NULL
);

-- ボトルキープ
CREATE TABLE bottle_keeps (
  id SERIAL PRIMARY KEY,
  customer_id UUID REFERENCES customers(id),
  product_name TEXT NOT NULL,
  opened_date DATE NOT NULL,
  expiry_date DATE,
  remaining_amount REAL -- 1.0 (新品), 0.75, 0.5, 0.25, 0.0 (空)
);

-- 勤怠記録
CREATE TABLE time_records (
  id BIGSERIAL PRIMARY KEY,
  staff_id UUID REFERENCES staffs(id),
  clock_in TIMESTAMPTZ NOT NULL,
  clock_out TIMESTAMPTZ
);
```

---

### 6. 開発ロードマップ

機能をフェーズ分けし、段階的に開発・導入を進めます。

#### **フェーズ1: MVP (Minimum Viable Product) - 3ヶ月**
*   **目標:** 紙の台帳やExcel管理を脱却し、基本的な業務がシステム上で完結する状態。
*   **実装機能:**
    1.  **基盤:** 認証、ユーザーロール管理
    2.  **顧客管理:** 基本情報登録・検索、来店履歴
    3.  **キャスト管理:** プロフィール、基本的な成績表示
    4.  **売上・会計:** 伝票作成、手動でのオーダー入力、会計計算、レジ締め
    5.  **予約管理:** シンプルなリスト形式での予約登録・確認
    6.  **勤怠管理:** 手動での出退勤時刻入力

#### **フェーズ2: オペレーション効率化 - 3ヶ月**
*   **目標:** 反復業務を自動化し、スタッフの負担を軽減。より詳細なデータ管理を実現。
*   **実装機能:**
    1.  **予約・席管理:** グラフィカルな席レイアウト、リアルタイム更新
    2.  **勤怠管理:** QRコードによる打刻機能
    3.  **在庫・ボトルキープ管理:** 在庫自動増減、ボトルキープ情報のデジタル化
    4.  **キャスト管理:** 報酬計算用データのエクスポート機能、ランキング機能の強化
    5.  **法令対応:** 年齢確認（身分証画像アップロード）、帳票出力機能

#### **フェーズ3: 売上拡大と外部連携 - 4ヶ月以降**
*   **目標:** 蓄積したデータを活用し、売上向上施策や経営分析に繋げる。
*   **実装機能:**
    1.  **フロアオーダー端末:** ホールスタッフやキャストがタブレットで直接オーダーを入力できるUI
    2.  **レポーティング & KPIダッシュボード:** 売上構成比、席回転率、キャスト別ARPUなどを可視化
    3.  **ロイヤルティ & ランク機能:** 来店回数や利用金額に応じた顧客ランク制度
    4.  **マーケティング機能:** LINE公式アカウントとの連携（誕生日メッセージ自動送信など）
    5.  **外部サービス連携:** 会計ソフト（freee/MF）への仕訳データ連携、決済ゲートウェイ連携

---

### 7. 開発方針・品質保証

本プロジェクトでは、長期的なシステムの安定稼働と拡張性を担保するため、以下の開発方針と品質基準を定めます。

#### 7.1. 開発目標
*   **メンテナンス性の確保:** 誰が読んでも理解しやすく、修正が容易なコードを維持します。いわゆる「スパゲッティコード」を排除し、コンポーネントの責務を明確に分離します。
*   **拡張性の確保:** 将来的な機能追加や仕様変更に柔軟に対応できる、疎結合なアーキテクチャを目指します。

#### 7.2. 開発手法
*   **テスト駆動開発 (TDD) の採用:** 「失敗するテストを書く → テストを通す最小限のコードを書く → リファクタリングする」というサイクルを基本とし、堅牢な設計と高い品質を両立させます。

#### 7.3. 品質基準 (制約事項)
*   **コーディング規約:**
    *   **ハードコード・マジックナンバーの禁止:** 設定値や定数は環境変数や設定ファイルで管理します。
    *   **厳格な型付け:** フロントエンドではTypeScriptを採用し、`any`型の使用を原則禁止します。
    *   **命名規則:** 変数名、関数名、ファイル名は、その役割が明確に分かるように命名します。
*   **テストカバレッジ:**
    *   主要なビジネスロジックについては、**テストカバレッジ80%以上**を必須とします。CI/CDパイプラインで自動計測し、基準値を下回る場合はマージをブロックします。
*   **エラーハンドリングとロギング:**
    *   予期せぬエラーが発生した場合でもシステムが停止しないよう、適切な例外処理を実装します。
    *   エラー発生時には、原因究明に必要な情報（エラー内容、発生箇所、リクエスト情報など）をログとして記録します。ログはSupabaseのテーブルまたは外部のログ管理サービスに集約します。

#### 7.4. 開発プロセスの自動化 (CI/CD)
開発効率と品質を担保するため、各種プロセスを自動化します。
*   **静的解析とフォーマット:** `git commit`時に、**ESLint**による静的解析と**Prettier**によるコードフォーマットを自動実行します。（`husky`と`lint-staged`を利用）
*   **自動テスト:** GitHub等でプルリクエストを作成した際に、全てのテストとカバレッジ計測を自動で実行します。
*   **自動デプロイ:** `main`ブランチへのマージをトリガーに、**Vercel**への本番環境デプロイが自動的に実行されます。

#### 7.5. 開発ドキュメント
本設計書とは別に、開発チーム向けに以下のドキュメントをリポジトリ内で管理・更新します。
*   **`README.md`:** プロジェクト概要、環境構築手順
*   **`CONTRIBUTING.md` / `DEVELOPMENT_GUIDE.md`:** コーディング規約、Gitブランチ戦略、TDDの具体的な進め方、AI活用ガイドなど、本プロジェクトにおける詳細な開発ルール。